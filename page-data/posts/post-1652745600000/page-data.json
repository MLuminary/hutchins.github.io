{"componentChunkName":"component---src-templates-post-detail-tsx","path":"/posts/post-1652745600000","result":{"data":{"site":{"siteMetadata":{"title":"Silence","author":"é»˜å°"}},"markdownRemark":{"id":"2ce4ea59-a0d1-5507-9176-f669876a1c72","excerpt":"è‡ªå·±åŠ¨æ‰‹å®ç°äº†ä¸€å¥—å‰ç«¯çŠ¶æ€ç®¡ç†ï¼Œè§£å†³äº† mobx ä¸ redux çš„ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ç—›ç‚¹ï¼Œå¹¶è®¾è®¡äº†ä¸€å¥—ä½¿ç”¨æ¨¡å¼åº”ç”¨åˆ°äº†æ—¥å¸¸é¡¹ç›®ä¸­ã€‚ å‰è¨€ redux å’Œ mobx ä¸é¦™å—ï¼Œä¸ºä»€ä¹ˆè¦è‡ªå·±åŠ¨æ‰‹å®ç°å‘¢ï¼Ÿåªèƒ½è¯´ä¸¤ä¸ªéƒ½é¦™ï¼Œä½†æ²¡é‚£ä¹ˆé¦™ ğŸ˜‰ã€‚ä¸‹é¢æˆ‘æµ…è°ˆä¸€ä¸‹è¿™ä¸¤ä¸ªåº“åœ¨æˆ‘ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›ç—›ç‚¹ Reduxâ€¦","html":"<blockquote>\n<p>è‡ªå·±åŠ¨æ‰‹å®ç°äº†ä¸€å¥—å‰ç«¯çŠ¶æ€ç®¡ç†ï¼Œè§£å†³äº† mobx ä¸ redux çš„ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ç—›ç‚¹ï¼Œå¹¶è®¾è®¡äº†ä¸€å¥—ä½¿ç”¨æ¨¡å¼åº”ç”¨åˆ°äº†æ—¥å¸¸é¡¹ç›®ä¸­ã€‚</p>\n</blockquote>\n<h2>å‰è¨€</h2>\n<p>redux å’Œ mobx ä¸é¦™å—ï¼Œä¸ºä»€ä¹ˆè¦è‡ªå·±åŠ¨æ‰‹å®ç°å‘¢ï¼Ÿåªèƒ½è¯´ä¸¤ä¸ªéƒ½é¦™ï¼Œä½†æ²¡é‚£ä¹ˆé¦™ ğŸ˜‰ã€‚ä¸‹é¢æˆ‘æµ…è°ˆä¸€ä¸‹è¿™ä¸¤ä¸ªåº“åœ¨æˆ‘ä½¿ç”¨è¿‡ç¨‹ä¸­çš„ä¸€äº›ç—›ç‚¹</p>\n<p><strong>Redux</strong></p>\n<ol>\n<li>å‰¯ä½œç”¨æ‰”ç»™ä¸­é—´ä»¶æ¥å¤„ç†ï¼Œå¯¼è‡´ç¤¾åŒºä¸€å †ä¸­é—´ä»¶</li>\n<li>å¤ªå¤šæ ·æ¿å¼ä»£ç ï¼Œä¸€ä¸ªç®€å•çš„æ›´æ–°ä¹Ÿè¦å†™å¾ˆå¤šä»£ç </li>\n</ol>\n<p><strong>Mobx</strong></p>\n<ol>\n<li>æ›´æ–°æ•°æ®æ²¡æœ‰çº¦æŸï¼Œå¯ä»¥éšæ„æ›´æ”¹</li>\n</ol>\n<h2>å®ç°</h2>\n<p>é¦–å…ˆï¼Œä½œä¸ºä¸€ä¸ªå‰ç«¯çŠ¶æ€ç®¡ç†åº“ï¼Œå¿…ä¸å¯å°‘çš„åŠŸèƒ½å½“ç„¶æ˜¯å“åº”å¼ï¼Œè¿™é‡Œé‡‡ç”¨ Rxjs æ¥å®ç°ã€‚è¯´åˆ° Rxjs å¯èƒ½å¤§å®¶éƒ½ä¼šæƒ³åˆ° <code class=\"language-text\">Observable</code>ï¼Œä½† <code class=\"language-text\">Observable</code> æœ¬èº«æ˜¯å•æ’­çš„ï¼Œè€Œä¸”å¹¶ä¸èƒ½ç»™å…¶æä¾›æ–°çš„å€¼ï¼Œä¹Ÿå°±æ˜¯å…¶å€¼æ˜¯ä¸èƒ½è¢«æ›´æ”¹çš„ï¼Œè¿™æ ·çš„è¯æ˜¾ç„¶æ˜¯æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„éœ€æ±‚çš„ï¼›ç”±æ­¤å¤§å®¶åˆå¯èƒ½ä¼šæƒ³åˆ° <code class=\"language-text\">BehaviorSubject</code>ï¼Œ <code class=\"language-text\">BehaviorSubject</code>æ˜¯å¯ä»¥å¾ˆç®€å•çš„é€šè¿‡ <code class=\"language-text\">next(newVal)</code>å»æ›´æ–°å€¼ï¼Œå¹¶ä¸”åœ¨æä¾›æ–°å€¼ä¹‹å‰çš„ subscriber éƒ½ä¼šè¢«é€šçŸ¥åˆ°ï¼Œä½†æ˜¯ï¼Œ<strong><code class=\"language-text\">BehaviorSubject</code>æ˜¯å¯ä»¥è¢«éšæ„ <code class=\"language-text\">next</code>çš„</strong>ï¼Œè¿™å’Œ mobx æœ‰åŒæ ·çš„é—®é¢˜ã€‚</p>\n<p>æˆ‘ä»¬å¯ä»¥åè§‚ <code class=\"language-text\">Observable</code> ä¸ <code class=\"language-text\">BehaviorSubject</code>ï¼Œ<code class=\"language-text\">BehaviorSubject</code>å¯ä»¥è®©æˆ‘ä»¬å¾ˆç®€å•çš„æ›´æ–°æ•°æ®ï¼Œ<code class=\"language-text\">Observable</code>çš„å€¼åˆå¢åŠ äº†çº¦æŸï¼Œè®©æˆ‘ä»¬ä¸èƒ½æ›´æ”¹å…¶å€¼ï¼Œé‚£æˆ‘ä»¬å¯ä¸å¯ä»¥è®©ä¸¤è€…ç»“åˆä¸€ä¸‹ï¼Ÿ</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Store<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Observable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">readonly</span> store <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n  <span class=\"token keyword\">private</span> currentValue<span class=\"token operator\">:</span> <span class=\"token constant\">T</span>\n  <span class=\"token keyword\">protected</span> _source<span class=\"token operator\">:</span> BehaviorSubject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>initialValue<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token comment\">// å°† Observable çš„ source æ›¿æ¢ä¸º BehaviorSubject</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>source <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_source <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BehaviorSubject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span>initialValue<span class=\"token punctuation\">)</span></span>    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentValue <span class=\"token operator\">=</span> initialValue\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">get</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentValue\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>nextValue<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t  <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>nextValue <span class=\"token keyword\">as</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">protected</span> <span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentValue <span class=\"token operator\">=</span> value\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">_emit</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token function\">_emit</span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_source<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token number\">4</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\na<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token comment\">// {value: 4}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\na<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// {value: 5}</span></code></pre></div>\n<p>ä»¥ä¸Šå°±æ˜¯è¿™ä¸ªçŠ¶æ€ç®¡ç†åº“çš„å…¨éƒ¨ï¼Œè¿™é‡Œå…³é”®çš„æ€è·¯å°±æ˜¯å°† Observable çš„ source æ›¿æ¢æˆ BehaviorSubjectï¼Œè¿™æ ·è¿™ä¸ªæ•°æ®åªèƒ½åœ¨å†…éƒ¨é€šè¿‡ next å»æ›´æ”¹ï¼Œè€Œå¯¹å¤–å…¶å®è¾“å‡ºçš„è¿˜æ˜¯ Observableï¼Œä½¿ç”¨è€…æ˜¯ä¸èƒ½éšæ„æ›´æ”¹çš„</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\">a<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token number\">5</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// { value: 5 }</span></code></pre></div>\n<p>ä¸Šé¢çš„æ›´æ–°æ–¹æ³•ä¼šæ¯”è¾ƒéº»çƒ¦è€Œä¸”è¿˜æœ‰å¯èƒ½å¼•èµ·é‡æ¸²æŸ“çš„é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å¼•å…¥ä¸å¯å˜æ•°æ®åº“ immer æ¥è§£å†³</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">type</span> <span class=\"token class-name\">Recipe<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>draft<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token keyword\">void</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Store<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">Observable<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">public</span> <span class=\"token keyword\">readonly</span> store <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span>\n  <span class=\"token keyword\">private</span> currentValue<span class=\"token operator\">:</span> <span class=\"token constant\">T</span>\n  <span class=\"token keyword\">protected</span> _source<span class=\"token operator\">:</span> BehaviorSubject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span>\n\n  <span class=\"token keyword\">constructor</span><span class=\"token punctuation\">(</span>initialValue<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">super</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>source <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_source <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">BehaviorSubject<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span></span><span class=\"token punctuation\">(</span>initialValue<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentValue <span class=\"token operator\">=</span> initialValue\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">get</span> <span class=\"token function\">value</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentValue\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">update</span><span class=\"token punctuation\">(</span>recipe<span class=\"token operator\">:</span> Recipe<span class=\"token operator\">&lt;</span><span class=\"token constant\">T</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> options<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> rollback<span class=\"token operator\">?</span><span class=\"token operator\">:</span> <span class=\"token builtin\">boolean</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>options<span class=\"token operator\">?.</span>rollback<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>nextValue<span class=\"token punctuation\">,</span> p<span class=\"token punctuation\">,</span> inversePatches<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">produceWithPatches</span><span class=\"token punctuation\">(</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span>\n        recipe\n      <span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>nextValue <span class=\"token keyword\">as</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">applyPatches</span><span class=\"token punctuation\">(</span>inversePatches<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span><span class=\"token function\">produce</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> recipe<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\t<span class=\"token comment\">// patch æ›´æ–°ï¼Œå¯ç”¨äºæ¨é€æ›´æ–°æ•°æ®</span>\n  <span class=\"token function\">applyPatches</span><span class=\"token punctuation\">(</span>patches<span class=\"token operator\">:</span> Patch<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token keyword\">void</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> nextValue <span class=\"token operator\">=</span> <span class=\"token function\">applyPatches</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">,</span> patches<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>nextValue<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">protected</span> <span class=\"token function\">emit</span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>currentValue <span class=\"token operator\">=</span> value\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span><span class=\"token function\">_emit</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">private</span> <span class=\"token function\">_emit</span><span class=\"token punctuation\">(</span>value<span class=\"token operator\">:</span> <span class=\"token constant\">T</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>_source<span class=\"token punctuation\">.</span><span class=\"token function\">next</span><span class=\"token punctuation\">(</span>value<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> a <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'haoqin'</span><span class=\"token punctuation\">,</span> age<span class=\"token operator\">:</span> <span class=\"token number\">23</span><span class=\"token punctuation\">,</span> obj<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'haoqin'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\na<span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">info</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\na<span class=\"token punctuation\">.</span><span class=\"token function\">pipe</span><span class=\"token punctuation\">(</span>\n  <span class=\"token function\">map</span><span class=\"token punctuation\">(</span>res <span class=\"token operator\">=></span> res<span class=\"token punctuation\">.</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">distinctUntilChanged</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span><span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span>info<span class=\"token punctuation\">)</span>\n\na<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>draft<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  draft<span class=\"token punctuation\">.</span>value <span class=\"token operator\">=</span> <span class=\"token number\">5</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h2>åº”ç”¨</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4f38f9c3a74aa7d4d5ca05b62fee5014/922e6/Store2x.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 13.513513513513512%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAYAAACTWi8uAAAACXBIWXMAAAsSAAALEgHS3X78AAAA9ElEQVQI1x3Oz0rCAACA8b1CvkAQHbr4BhJ0DerSI/QIHrp4EepSUFAUyHIQRSVWgmQQWRIdnEpTJKfhIdpc0y3/VP7Z8vC1PHz8rp+wUcqz81Jk3fOxoTMaulj5JPa9iJ2RvI7otk0+zRHViE5NNFAPGtQvTPq/YwrlGlIsycnVzURBiG4yFRf5dy33hNMboG8t0gxO0wz5+QjOYNZl3pQvrn0yt7MKKV+B9HyR77HD7uEZc4FlFlZWPZcQworMdvmZsJIlo2kM+w6tbALrLoL1INFKR+nYBpYxoLL/jupdVvY0Xs8NflyXXElFPE1wfJma+Adue7urCDPwPwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Store@2x.png\"\n        title=\"Store@2x.png\"\n        src=\"/static/4f38f9c3a74aa7d4d5ca05b62fee5014/fcda8/Store2x.png\"\n        srcset=\"/static/4f38f9c3a74aa7d4d5ca05b62fee5014/12f09/Store2x.png 148w,\n/static/4f38f9c3a74aa7d4d5ca05b62fee5014/e4a3f/Store2x.png 295w,\n/static/4f38f9c3a74aa7d4d5ca05b62fee5014/fcda8/Store2x.png 590w,\n/static/4f38f9c3a74aa7d4d5ca05b62fee5014/efc66/Store2x.png 885w,\n/static/4f38f9c3a74aa7d4d5ca05b62fee5014/c83ae/Store2x.png 1180w,\n/static/4f38f9c3a74aa7d4d5ca05b62fee5014/922e6/Store2x.png 2140w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>æ•°æ®å±‚ä¸€å…±åˆ†ä¸ºå››å±‚ï¼Œé¦–å…ˆä»‹ç» Repoã€‚Repo æ˜¯ç”¨äºå­˜æ”¾åç«¯ api çš„åœ°æ–¹ï¼Œåœ¨è¿™é‡Œå¯ä»¥å°†å¤šä¸ª api æŒ‰åŠŸèƒ½ç»Ÿä¸€æ‰ï¼Œä¹Ÿå¯ä»¥ç»Ÿä¸€åç«¯ api çš„è¿”å›ï¼Œè®© store å±‚æ‹¿åˆ°ç¨³å®šçš„æ•°æ®ç»“æ„ã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Repo</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token function-variable function\">updateTask</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> TaskId<span class=\"token punctuation\">,</span> values<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>TaskSchema<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> keys <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>keys<span class=\"token punctuation\">.</span><span class=\"token function\">includes</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">return</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">'xxx'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n\t\t\t\tmethod<span class=\"token operator\">:</span> <span class=\"token string\">'put'</span>\n\t\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Store å°±æ˜¯æˆ‘ä»¬æ•°æ®å­˜å‚¨çš„åœ°æ–¹ï¼Œè¿™é‡Œå­˜æ”¾äº†æˆ‘ä»¬æ‰€éœ€è¦çš„å„ç§æ•°æ®ï¼Œè¿™é‡Œä¹Ÿæ˜¯<strong>å”¯ä¸€èƒ½æ“ä½œæ•°æ®çš„åœ°æ–¹</strong>ï¼Œæ‰€ä»¥è·å–æ•°æ®ä¸æ“ä½œæ•°æ®çš„æ–¹æ³•éƒ½ä¼šåœ¨è¿™ä¸€å±‚ç»Ÿä¸€æš´éœ²ç»™ Presenter</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Store</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">protected</span> repo <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Repo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// å­˜å‚¨æ•°æ®çš„åœ°æ–¹</span>\n\t<span class=\"token keyword\">readonly</span> root <span class=\"token operator\">=</span> <span class=\"token function\">createStore</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> tasks<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Map</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token keyword\">async</span> <span class=\"token function\">updateTask</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> TaskId<span class=\"token punctuation\">,</span> values<span class=\"token operator\">:</span> Partial<span class=\"token operator\">&lt;</span>TaskSchema<span class=\"token operator\">></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">const</span> rollback <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>root<span class=\"token punctuation\">.</span><span class=\"token function\">update</span><span class=\"token punctuation\">(</span>draft <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token keyword\">const</span> task <span class=\"token operator\">=</span> draft<span class=\"token punctuation\">.</span>tasks<span class=\"token punctuation\">.</span><span class=\"token keyword\">get</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n\t\t\t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>task<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span>\n\t\t\t<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> key <span class=\"token keyword\">of</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>values<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t\t<span class=\"token comment\">// ä¹è§‚æ›´æ–°</span>\n\t\t\t\ttask<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> values<span class=\"token punctuation\">[</span>key<span class=\"token punctuation\">]</span>\n\t\t\t<span class=\"token punctuation\">}</span>\n\t\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> rollback<span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n\t\t<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// è°ƒç”¨æ›´æ–°æ–¹æ³•å®é™…æ›´æ–°</span>\n\t\t\t<span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>repo<span class=\"token punctuation\">.</span><span class=\"token function\">updateTask</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">,</span> values<span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\t\t\t<span class=\"token comment\">// å¦‚æœå‡ºé”™åˆ™æ’¤å›</span>\n\t\t\t<span class=\"token function\">rollback</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Presenter è¿™ä¸€å±‚å°±ä¼šä¸è§†å›¾ç›´æ¥æ²Ÿé€šï¼Œä¸€äº›ç°åº¦ç­–ç•¥å¯èƒ½å°±ä¼šåœ¨è¿™é‡Œå¤„ç†æ‰ã€‚ç»è¿‡äº† Repo ã€Storeã€Presenter çš„å±‚å±‚é˜²æŠ¤ï¼Œæš´éœ²ç»™è§†å›¾çš„ api ä¹Ÿä¼šæ›´åŠ çš„ç¨³å®šã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"ts\"><pre class=\"language-ts\"><code class=\"language-ts\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Presenter</span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">protected</span> store <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Store</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n\t<span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span>id<span class=\"token operator\">:</span> TaskId<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>store<span class=\"token punctuation\">.</span><span class=\"token function\">getTask</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>å› æ­¤æˆ‘ä»¬ Page å°±æ˜¯è§†å›¾å±‚ï¼Œæ¯ä¸€ä¸ª Page å¯¹åº”ä¸€å¥— Presenter ã€Storeã€Repoã€‚</p>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// task-detail.context</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> TaskDetailContext <span class=\"token operator\">=</span> <span class=\"token function\">createContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> useTaskDetailContext <span class=\"token operator\">=</span> <span class=\"token function\">useContext</span><span class=\"token punctuation\">(</span>TaskDetailContext<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">TaskDetailContextProvider</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\n\t<span class=\"token keyword\">const</span> value <span class=\"token operator\">=</span> <span class=\"token function\">useMemo</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n\t\t\tpresenter<span class=\"token operator\">:</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Presenter</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TaskDetailContext.Provider</span></span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span> value <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token punctuation\">{</span> props<span class=\"token punctuation\">.</span>children <span class=\"token punctuation\">}</span><span class=\"token plain-text\">\n\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">TaskDetailContext.Provider</span></span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// task-detail.page</span>\n<span class=\"token keyword\">const</span> TaskDetailInner<span class=\"token operator\">:</span> <span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> presenter <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> <span class=\"token function\">useTaskDetailContext</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\t<span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> TaskDetail<span class=\"token operator\">:</span> <span class=\"token function-variable function\">FC</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n\t<span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n\t\t<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TaskDetailContextProvider</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">\n\t\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TaskDetailInner</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\">\n\t\t</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span><span class=\"token class-name\">TaskDetailContextProvider</span></span><span class=\"token punctuation\">></span></span>\n\t<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>è¿™æ ·æˆ‘ä»¬çš„ Page å°±è·å¾—äº† Presenter ä¸­çš„æ‰€æœ‰æ•°æ®ä¸æ“ä½œæ•°æ®çš„æ–¹æ³•ï¼Œä¸‹é¢å°±å¯ä»¥æ„‰å¿«çš„ç¼–å†™æˆ‘ä»¬çš„ UI ç•Œé¢äº†</p>","frontmatter":{"title":"è‡ªå·±åŠ¨æ‰‹å®ç°çŠ¶æ€ç®¡ç†","date":"May 17, 2022"}}},"pageContext":{"slug":"/è‡ªå·±åŠ¨æ‰‹å®ç°çŠ¶æ€ç®¡ç†åº“/","previous":null,"next":{"fields":{"slug":"/å»ºç«‹ä¸€ä»½è‡ªå·±çš„æŠ€æœ¯å›¾è°±/"},"frontmatter":{"title":"å»ºç«‹ä¸€ä»½è‡ªå·±çš„æŠ€æœ¯å›¾è°±","date":"2022-05-12 00:34:12"}},"nextPath":"/posts/post-1652286852000"}},"staticQueryHashes":["1747850863","63159454"]}