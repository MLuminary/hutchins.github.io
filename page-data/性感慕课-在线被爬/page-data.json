{"componentChunkName":"component---src-templates-post-detail-tsx","path":"/性感慕课-在线被爬/","webpackCompilationHash":"d26d329850f03a37d00b","result":{"data":{"site":{"siteMetadata":{"title":"Silence","author":"默尝"}},"markdownRemark":{"id":"9a7d1e98-c107-5258-a5d4-6bfc6de1b622","excerpt":"性感慕课在线被爬 在学习了 alsotang 大神的 《Node.js 包教不包会》后的一个爬虫小练习，期间也碰到挺多小问题，也学到了很多小东西。「单押 ×3」:trollface: 这里是大神的教程地址 https://github.com/alsotang/node-lessons…","html":"<h1>性感慕课在线被爬</h1>\n<blockquote>\n<p>在学习了 alsotang 大神的 《Node.js 包教不包会》后的一个爬虫小练习，期间也碰到挺多小问题，也学到了很多小东西。「单押 ×3」:trollface:</p>\n</blockquote>\n<p>这里是大神的教程地址 <a href=\"https://github.com/alsotang/node-lessons%EF%BC%8C%E4%B8%8B%E9%9D%A2%E6%98%AF%E8%87%AA%E5%B7%B1%E7%9A%84%E7%88%AC%E5%8F%96%E6%95%88%E6%9E%9C%E5%9B%BE\">https://github.com/alsotang/node-lessons，下面是自己的爬取效果图</a></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 318px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e998942125ebd194ce0fd280cbbd66d7/54bc5/spider2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 206.28930817610063%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAApCAYAAAA1bQl+AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAE7klEQVRIx51Wi3aiSBD1/39o95x9TDaTmcxmoknGRPGF4FtQBJQ33XermoBonEe2j3W6gaaspu6tuo0gCJDnOepDSvluK99rsLMkSXA4HE4evneU7zXKG1mWKaf8B1JImgV4SyYyCCkQZzGSPEGURWoO0gB+7Kv5JMJ6REIINc90E19vvsLZeRi7Y+iOjtaihafVE26nt2iv2/i2+oaH5QM6VgdZnr11WD/ulBze/HWDzjcNbuRBszWYronmookv0y+YelMkWVJ9e/Uun0e+Hlk5qjk0BiM0b1uIohhtq4272R12wQ5pLZLvWaP+QasIxyZan5uI0xSDXR/aRsPEm6hv9rPROM8Sj/6zhqvf/4HjuJg7Szj7HUQCpFGONMmQxBnyjBIVpkiiTFkU0JoCaNS/XZrykSSM4RjGyKTrHOaLhbXhYmXuYHYtzAdbTDQba9OF0bEw7W9g0J4ZzXs/PB45Je9xHCv4nEYtFWxOP4s8zihm1JMSRRFms1nlNAxCMIP4fhiF1RyGxfpHphwyU3zfVzfOafje0ShZwsYR8hG2awt6XyeWCFiBBetgwT7YWO1XlPn4h9CpHLKzckxHhgL2oDvCJtjief2Mrt2FsTOqfd/j/anD1+dGf4SbP2+wnK0w2A5wP7/HPtorHp8z62KE7KweoTHQ8XT3CC4PHetF8dXYmfAjv0jmz5hy7pCZcnt1C9f1MT1MsA7WSERMfyB+PSlFQorReXzGPXHZ3wcYPM+xNBxYE0+Bd6E7mA02sGceAd2m9RbTno1xe42N7R4jZKeMQYZNmtB1WgA8OhA2iVZMs+iQINyT+YmiGs/VNe0TRMcKh8vlUjljx7nIq7WQeXEtXtdk5T2h1uLV+J2s4DI7dBxHAbukX9kaONI8oyqeURUnboN+vOZo+CS8p24nBZbppnhNGw/0/XiEWQg3drHcL+EnPub+XCVpG25VlBeTcg5SLrDXf1xjQTj0Yk/h8IP+QVVqLv/9bR8Td0LlKnmDycstgJjy6e/PxJQhMWWj+ogTOD/sdhcL7LEF6Hj494ESICmiZzTnLay8FYIkVHtywUl4RwuYcQu4bSKgcmXuh9T5Blgepojzw/9rAVq7q4rDZutDo0q9sA7w6MQbm2wrYNsCnicJalSNrMKmU4GdH5+2AIaMJEwtpwtKyIL6LdDTBExT0gs5NC3HcJij18sxmYjqutvNMR7n9Cd5ESE3eFYNBf7qfJVn8y8U2LKfuK57oiDY+JkQl+3Sswo2/DI7LbXNr4giiaNaeJPlo2AqnC0nM7SbbRwoy6xtGMQMbtYyrGlY5zAumcPnCW2cIr24OSFgM1M6T11iiq+Y0dv08NH8iGvjGvpOR0iYTLP0rcMqy7Vsm9Tov366h7fzcb+4r1oASzqWd2mevunVb4FdczgZjfFITEmJ/B27o/g7cobwSIld+KrfLw6lQ703xNVvV9iStllRZXFD0ja5UJmsq4XjOyxQWZzmp8AuM8xiSSMLIoFWK8NoJMhyPD0VIG63c+h6jsfHDC8vfD9T+9Z2coyQocMFttQ2Kg7J7UESg6Sas6xYJ8mplc856exQEgYlVexK9aghyryzcW0Rr2tZU0fnJqU6Mh91v98rLpc6+2fgljX39Wt2WP0DHZkCE9LfuXI1X0sSkJK0jSQJIofOUDqhI0nFHk9xYfwHOoxqW2FcOxAAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"spider2\"\n        title=\"spider2\"\n        src=\"/static/e998942125ebd194ce0fd280cbbd66d7/54bc5/spider2.png\"\n        srcset=\"/static/e998942125ebd194ce0fd280cbbd66d7/cf440/spider2.png 148w,\n/static/e998942125ebd194ce0fd280cbbd66d7/d2d38/spider2.png 295w,\n/static/e998942125ebd194ce0fd280cbbd66d7/54bc5/spider2.png 318w\"\n        sizes=\"(max-width: 318px) 100vw, 318px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><a href=\"https://github.com/MLuminary/subentry/blob/master/easySpider/imoocSpider/app.js\">imoocSpider 练习源码</a></p>\n<h2>搭建服务器</h2>\n<p>首先，搭建一个 http 服务</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> http <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'http'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">var</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">var</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\nhttp<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>app<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span><span class=\"token number\">8080</span><span class=\"token punctuation\">)</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//code here...</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>用的是 <code class=\"language-text\">express</code> 搭建的，当然也可以用原生的，在这里自己比较习惯用 <a href=\"http://www.expressjs.com.cn/\">express</a></p>\n<h2>在线爬虫</h2>\n<p>在这里用到的是 <code class=\"language-text\">superagent</code> 和 <code class=\"language-text\">cheerio</code> 来爬取页面，这里有相关文档可以参考: <a href=\"https://cnodejs.org/topic/5378720ed6e2d16149fa16bd\">superagent 中文文档</a>、<a href=\"https://cnodejs.org/topic/5203a71844e76d216a727d2e\">cheerio</a>，都是来自 cnode 社区，当然英语能力较好的也可以参考原文档。在这里就只贴出这两个</p>\n<p>爬取页面链接 <a href=\"https://www.imooc.com/course/list?c=fe\">https://www.imooc.com/course/list?c=fe</a></p>\n<p>我们是要爬取慕课网前端开发八个页面的课程中的一些信息，但是打开此链接发现每个页面只有课程的名称，并没有老师的名称和一些课程的主要信息。因此我们还需要获取并根据每个课程的 url 进行爬取。</p>\n<p><strong>获取课程详情页链接</strong></p>\n<p>那我们先来爬取八个页面的所有课程详情页的 <code class=\"language-text\">url</code></p>\n<p>通过点击对应页面的按钮，发现每次都会发送一个新的 get 请求，请求的链接就是对应的页面，而这里的链接只有 <code class=\"language-text\">page</code> 属性是不同的，因此我们通过动态改变 <code class=\"language-text\">page</code> 就可以模拟点击对应页来获取对应页的信息</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> pages <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">var</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'https://www.imooc.com/course/list/'</span>\n\n<span class=\"token keyword\">var</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  c<span class=\"token punctuation\">:</span> <span class=\"token string\">'fe'</span><span class=\"token punctuation\">,</span>\n  page<span class=\"token punctuation\">:</span> page\n<span class=\"token punctuation\">}</span>\n\nsuperagent\n  <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>baseUrl<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> topicUrls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">var</span> $ <span class=\"token operator\">=</span> cheerio<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> courseCard <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.course-card-container'</span><span class=\"token punctuation\">)</span>\n    courseCard<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">index<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> $element <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">var</span> href <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>\n        homeUrl<span class=\"token punctuation\">,</span>\n        $element<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.course-card'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n\n      topicUrls<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>href<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>topicUrls<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>这样就可以获取到了第一个页面的 25 个课程的详情页的 url，那要如何获取八个页面呢。</p>\n<p><strong>async</strong></p>\n<p>因为有些网站通常都会有安全限制，不会允许同一个域名有过大的高并发数，因此需要限制并发数，在这里用我们用到了 <code class=\"language-text\">async</code> 这个库。这里是其 <a href=\"https://github.com/caolan/async\">github</a></p>\n<p>我们首先把前面代码封装成一个函数</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> baseUrl <span class=\"token operator\">=</span> <span class=\"token string\">'https://www.imooc.com/course/list/'</span>\n<span class=\"token keyword\">var</span> <span class=\"token function-variable function\">fetchUrl</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">page<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  count<span class=\"token operator\">++</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'当前并发数'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">var</span> params <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    c<span class=\"token punctuation\">:</span> <span class=\"token string\">'fe'</span><span class=\"token punctuation\">,</span>\n    page<span class=\"token punctuation\">:</span> page\n  <span class=\"token punctuation\">}</span>\n\n  superagent\n    <span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>baseUrl<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">query</span><span class=\"token punctuation\">(</span>params<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">var</span> topicUrls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      <span class=\"token keyword\">var</span> $ <span class=\"token operator\">=</span> cheerio<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n      <span class=\"token keyword\">var</span> courseCard <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.course-card-container'</span><span class=\"token punctuation\">)</span>\n      courseCard<span class=\"token punctuation\">.</span><span class=\"token function\">each</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">index<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">var</span> $element <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">var</span> href <span class=\"token operator\">=</span> url<span class=\"token punctuation\">.</span><span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>\n          homeUrl<span class=\"token punctuation\">,</span>\n          $element<span class=\"token punctuation\">.</span><span class=\"token function\">find</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.course-card'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">attr</span><span class=\"token punctuation\">(</span><span class=\"token string\">'href'</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">)</span>\n\n        topicUrls<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>href<span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n      <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">,</span> topicUrls<span class=\"token punctuation\">)</span>\n      count<span class=\"token operator\">--</span>\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'释放并发数后当前并发数'</span><span class=\"token punctuation\">,</span> count<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后用 <code class=\"language-text\">async</code> 控制并发数和八个页面的抓取</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> pages <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4</span><span class=\"token punctuation\">,</span> <span class=\"token number\">5</span><span class=\"token punctuation\">,</span> <span class=\"token number\">6</span><span class=\"token punctuation\">,</span> <span class=\"token number\">7</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\nasync<span class=\"token punctuation\">.</span><span class=\"token function\">mapLimit</span><span class=\"token punctuation\">(</span>\n    pages<span class=\"token punctuation\">,</span>\n    <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">page<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">fetchUrl</span><span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n      console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>这样所有的 url 就被打印出来，这里要注意一下，<code class=\"language-text\">async</code> 会自动把第三个函数参数的返回值合并成一个数组给第四个函数参数的 <code class=\"language-text\">result</code> 参数。刚开始写的时候我把 <code class=\"language-text\">topicUrls</code> 声明在了全局，以至于返回成下面这组数据</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/f8567cf8ef68e04b41f137cc84b3a303/ebcd6/spider1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25.993189557321227%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAsUlEQVQY04WPQQqEMAxFvf+FBI/hxoW6cWOrFW0rKKL/T5rBzTDjBD4tgby8ZJObMAyDpq5rVFWFcRyxritCCPDeY1kWzPOMfd+R6rqun8liiDTGMMZIay3btqUMc9s2ClT76RUwBch/lUUf0fc9nHMoyxJ5nqtpskrWsgyyCF3XaU9m8FQJSGssBUgBsigKNk2jlslYlukFAlRLvomar4bneVJu16T/cRz87N25IU/AF5lbgQS7n/m5AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"spider1\"\n        title=\"spider1\"\n        src=\"/static/f8567cf8ef68e04b41f137cc84b3a303/b9e4f/spider1.png\"\n        srcset=\"/static/f8567cf8ef68e04b41f137cc84b3a303/cf440/spider1.png 148w,\n/static/f8567cf8ef68e04b41f137cc84b3a303/d2d38/spider1.png 295w,\n/static/f8567cf8ef68e04b41f137cc84b3a303/b9e4f/spider1.png 590w,\n/static/f8567cf8ef68e04b41f137cc84b3a303/ebcd6/spider1.png 881w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><strong>爬取课程详情页的信息</strong></p>\n<p>在我们有了所有课程详情页的 url 后，我们开始爬取里面的内容。首先定义一个函数</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> <span class=\"token function-variable function\">fetchMsg</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">topicUrl<span class=\"token punctuation\">,</span> callback</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'开启新一轮抓取'</span><span class=\"token punctuation\">)</span>\n  superagent<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span>topicUrl<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> content</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">var</span> Item <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">var</span> $ <span class=\"token operator\">=</span> cheerio<span class=\"token punctuation\">.</span><span class=\"token function\">load</span><span class=\"token punctuation\">(</span>content<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">var</span> title <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.hd .l'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//课程名字</span>\n    <span class=\"token keyword\">var</span> teacher <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.tit a'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//老师名字</span>\n    <span class=\"token keyword\">var</span> level <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.meta-value'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//难度</span>\n    <span class=\"token keyword\">var</span> time <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.meta-value'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//时长</span>\n    <span class=\"token keyword\">var</span> number <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.meta-value'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//学习人数</span>\n    <span class=\"token keyword\">var</span> grade <span class=\"token operator\">=</span> <span class=\"token function\">$</span><span class=\"token punctuation\">(</span><span class=\"token string\">'.meta-value'</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">eq</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">.</span><span class=\"token function\">trim</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//评分</span>\n\n    Item<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n      title<span class=\"token punctuation\">:</span> title<span class=\"token punctuation\">,</span>\n      teacher<span class=\"token punctuation\">:</span> teacher<span class=\"token punctuation\">,</span>\n      level<span class=\"token punctuation\">:</span> level<span class=\"token punctuation\">,</span>\n      time<span class=\"token punctuation\">:</span> time<span class=\"token punctuation\">,</span>\n      number<span class=\"token punctuation\">:</span> number<span class=\"token punctuation\">,</span>\n      grade<span class=\"token punctuation\">:</span> grade<span class=\"token punctuation\">,</span>\n      href<span class=\"token punctuation\">:</span> topicUrl\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">callback</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span> Item<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>然后用 <code class=\"language-text\">async</code> 控制并发爬取</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token comment\">//result 为上文中的 result，下面的代码也都是在上文中的第四个参数中</span>\n\n<span class=\"token keyword\">var</span> topicUrls <span class=\"token operator\">=</span> result<span class=\"token punctuation\">;</span> <span class=\"token comment\">//获取所有 url ，但是大数组里面有 8 个小数组</span>\n\n<span class=\"token keyword\">var</span> Urls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token comment\">//将大数组合并</span>\n<span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i<span class=\"token operator\">=</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span>l<span class=\"token operator\">=</span>topicUrls<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span>i<span class=\"token operator\">&lt;</span>l<span class=\"token punctuation\">;</span>i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  Urls <span class=\"token operator\">=</span> Urls<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>topicUrls<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nasync<span class=\"token punctuation\">.</span><span class=\"token function\">mapLimit</span><span class=\"token punctuation\">(</span>\n  Urls<span class=\"token punctuation\">,</span>\n  <span class=\"token number\">5</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url<span class=\"token punctuation\">,</span>callback</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n    <span class=\"token function\">fetchMsg</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> callback<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> result</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//避免乱码</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">writeHead</span><span class=\"token punctuation\">(</span><span class=\"token number\">200</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">:</span> <span class=\"token string\">'text/plain;charset=utf8'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span><span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>result<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span></code></pre></div>\n<p>这里要注意一个小问题，就是 <code class=\"language-text\">result</code> 获取到的 url 结构是一个大数组里面包含八个小数组，因此需要将其小数组先合并成一个大数组。</p>\n<h2>最后</h2>\n<p><a href=\"https://github.com/MLuminary/subentry/blob/master/easySpider/imoocSpider/app.js\">项目源码</a></p>\n<p>每天探索一点点，每天进步一点点。</p>","frontmatter":{"title":"性感慕课在线被爬","date":"May 02, 2018"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/性感慕课-在线被爬/","previous":{"fields":{"slug":"/今天这个仇先记下来/"},"frontmatter":{"title":"今天这个仇先记下来"}},"next":{"fields":{"slug":"/前端安全/"},"frontmatter":{"title":"前端安全"}}}}}