{"componentChunkName":"component---src-templates-post-detail-tsx","path":"/获取百度搜索提示结果/","webpackCompilationHash":"5ee947e49c106553cd05","result":{"data":{"site":{"siteMetadata":{"title":"Silence","author":"默尝"}},"markdownRemark":{"id":"0a9fb664-c58d-5a03-9d55-fba01ebc0d2e","excerpt":"获取百度搜索提示结果 最近比较闲就想去搞点事情，注视着搜索引擎就在想我们每天都在用搜索引擎，自己就想了解一下其中的原理，于是就动手做了一个，只不过数据是爬的 😝，并想实现如下搜索提示的功能  本来觉得查查 network…","html":"<h1>获取百度搜索提示结果</h1>\n<blockquote>\n<p>最近比较闲就想去搞点事情，注视着搜索引擎就在想我们每天都在用搜索引擎，自己就想了解一下其中的原理，于是就动手做了一个，只不过数据是爬的 😝，并想实现如下搜索提示的功能</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/52b71f0afc61ccfef98f3940f44afd54/3b44a/pg1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 42.96636085626911%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAAJABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAQAF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB3khiP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEAAQUCX//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABYQAAMAAAAAAAAAAAAAAAAAAAEQMf/aAAgBAQABPyERiP8A/9oADAMBAAIAAwAAABDQz//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8QP//EABoQAQABBQAAAAAAAAAAAAAAAAEQABExYXH/2gAIAQEAAT8Qdy6hKx8n/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pg1\"\n        title=\"pg1\"\n        src=\"/static/52b71f0afc61ccfef98f3940f44afd54/c739e/pg1.jpg\"\n        srcset=\"/static/52b71f0afc61ccfef98f3940f44afd54/8ee9c/pg1.jpg 148w,\n/static/52b71f0afc61ccfef98f3940f44afd54/ebbe7/pg1.jpg 295w,\n/static/52b71f0afc61ccfef98f3940f44afd54/c739e/pg1.jpg 590w,\n/static/52b71f0afc61ccfef98f3940f44afd54/3b44a/pg1.jpg 654w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>本来觉得查查 network 随便抓取一下就可以获得到数据，但事情却不是这么简单</p>\n<h2>过程</h2>\n<p>在百度在随便输入字符，查看 network，找到此时请求的链接</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 399px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cf53f121af00a2c7525512498b645ced/1341e/pg2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 140.85213032581453%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAcCAIAAADuuAg3AAAACXBIWXMAAAsSAAALEgHS3X78AAACT0lEQVQ4y43V6ZIaMQwEYN7/7Sj4tRTFzQz3fYcl31iEEGAJqsJle9TqlmSb0mg06vV6eZ4bF4vFdDrdbrfdbtdOLIfD4Ww2G4/H5lmWtdvtRqPBAbA0mUzq9Xqr1eKd5dlgMBCl0+kYOVn+emXn85lDSch+vy9kq9kaZAPhEV4uFx7H45HT5Qcrl8sFuNAwHPXz/tfiS6Dlcnn5wKrVaol0YPKarWZn0pYF8s1mI/P5fP4mUKVSKakH9fhVYjycrNdr+PFoDBaB7Ii13+9fgGWIFgm8qnKdJ1utVsE8TBaF+P5jV7DC+ka8EMrmg1JBglH+JucCzAkMZ/CDUavOwfPA9ggGky1+tCQQL0pwPgNeMMPcyONI7Xa7/7bqyux4aa+GOVLOGeXS/giMmWCc8JH2MZneHA6HmGyTPWRRgHkDS9UYN0Hl8U+S2bGMzRfguFXEk2CMrpJgX8RRspeVK8CiBhiJkzRNFqfChK44ZM/Fv54wgsGiW6QGJ5gQcSp/ZI4mwXBVZ7tRHuGi5i9PyBWsNoEPqcorhAlm3bZU830yEfd3BlJUm2A6b6XSs+JVSSlY6r+vxVVLoxKAxbUt+cFziuthFzJGEnzlejqdnmWr4vWE4eFtIgqG202MhM/Jvv+1AozExYAkr9lsikVISIgX8/6qPDLTFvcBORinW2PflPqvbAVDHu+B8cNbVYClR7AyxrsPSUI8+iH4/pz6envbSC5axRUg0gs80zBjnix60UtmwlOIa6sgo9W1Wi1LFvXnKkT8v9jhY7SMpgD+BovtMoydoLOeAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pg2\"\n        title=\"pg2\"\n        src=\"/static/cf53f121af00a2c7525512498b645ced/1341e/pg2.png\"\n        srcset=\"/static/cf53f121af00a2c7525512498b645ced/cf440/pg2.png 148w,\n/static/cf53f121af00a2c7525512498b645ced/d2d38/pg2.png 295w,\n/static/cf53f121af00a2c7525512498b645ced/1341e/pg2.png 399w\"\n        sizes=\"(max-width: 399px) 100vw, 399px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>会发现使用 get 方式传了四个值,其中 <code class=\"language-text\">p</code> 和 <code class=\"language-text\">cb</code> 都是可以固定的，剩下的就是关键字 <code class=\"language-text\">wd</code> 和此时的时间戳 <code class=\"language-text\">t</code>，自己因为本身是 vue 的项目，就用 <code class=\"language-text\">axios</code> 对此进行请求，结果报错为 <strong>跨域</strong> 并且 <strong>中文乱码</strong></p>\n<h3>gzip</h3>\n<p>因为发生了跨域，因此就想用 <code class=\"language-text\">node</code> 去修改请求头去请求，「后来发现用 <code class=\"language-text\">node</code> 去请求不需要修改请求头也不会跨域」，但是还有一个问题返回的中文都是乱码。然后我就去关注了一下响应头，如上面的图片，其中 <code class=\"language-text\">content-encoding: gzip</code> 引起了我的注意。</p>\n<p>gzip 是什么在此我就不做过多的解释，去网上查只是说想要<strong>获取 gzip 格式的网页信息需要解压，要不然获得到的信息会是乱码</strong>，其中用到了 <code class=\"language-text\">zlib</code> 和 <code class=\"language-text\">request</code> 两个包</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\">  zlib <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'zlib'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">response</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> res<span class=\"token punctuation\">,</span> body</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"token comment\">//check res header it is gzip</span>\n console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>res<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'content-encoding'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token comment\">//now body it is gzip stream buffer</span>\n      zlib<span class=\"token punctuation\">.</span><span class=\"token function\">unzip</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> buffer</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n             console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>buffer<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n       <span class=\"token punctuation\">}</span>\n\n<span class=\"token punctuation\">}</span>\n    request<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n        url <span class=\"token punctuation\">:</span> apiUrl<span class=\"token punctuation\">,</span>\n        headers<span class=\"token punctuation\">:</span> <span class=\"token punctuation\">{</span>\n            <span class=\"token string\">'Accept-Encoding'</span> <span class=\"token punctuation\">:</span> <span class=\"token string\">'gzip'</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n        encoding <span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>  <span class=\"token comment\">// it is very import!!</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>但是我满怀期待的将其解压提取信息后获得的结果依然是乱码，make my heart cold cold</p>\n<p><strong>gbk</strong></p>\n<p>最后又把目光转向响应头，感觉 <code class=\"language-text\">charset=gbk</code> 好像有点东西, 其中用到了 <code class=\"language-text\">iconv-lite</code> ，是一个转编码的工具，<code class=\"language-text\">iconv.decode</code> 接受到第一个参数必须是 <code class=\"language-text\">buffer</code>, 而 <code class=\"language-text\">request</code> 获取到的信息返回的也是 <code class=\"language-text\">buffer</code> 我就感觉冥冥之中放佛预示着什么</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token function\">request</span><span class=\"token punctuation\">(</span>\n  <span class=\"token punctuation\">{</span>\n    url<span class=\"token punctuation\">,</span>\n    encoding<span class=\"token punctuation\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token keyword\">function</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">err<span class=\"token punctuation\">,</span> response<span class=\"token punctuation\">,</span> body</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">setHeader</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Content-Type'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'application/json; charset=utf-8'</span><span class=\"token punctuation\">)</span>\n    res<span class=\"token punctuation\">.</span><span class=\"token function\">end</span><span class=\"token punctuation\">(</span>iconv<span class=\"token punctuation\">.</span><span class=\"token function\">decode</span><span class=\"token punctuation\">(</span>body<span class=\"token punctuation\">,</span> <span class=\"token string\">'gbk'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>因此将响应头设置为 utf-8 并将其 gbk 编码转换为 utf-8 后成功的获得到了需要的信息, 下面就是将此 api 部署到我自己的服务器上，关于部署碰到的一些问题基本都在我另一篇文章中有谈到 <a href=\"https://github.com/MLuminary/Blog/issues/15\">记一次 oneinstack 配置服务器</a></p>","frontmatter":{"title":"获取百度搜索提示结果","date":"August 02, 2018"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/获取百度搜索提示结果/","previous":{"fields":{"slug":"/让服务器带点绿/"},"frontmatter":{"title":"让服务器带点绿"}},"next":{"fields":{"slug":"/基于mpvue的圆形进度条组件/"},"frontmatter":{"title":"基于 mpvue 的圆形进度条组件"}}}}}