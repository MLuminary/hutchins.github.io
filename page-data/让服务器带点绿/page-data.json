{"componentChunkName":"component---src-templates-post-detail-tsx","path":"/让服务器带点绿/","webpackCompilationHash":"5ee947e49c106553cd05","result":{"data":{"site":{"siteMetadata":{"title":"Silence","author":"默尝"}},"markdownRemark":{"id":"75780cc7-f48f-5fee-aca6-7e041bfb7432","excerpt":"让服务器带点绿 这段时间终于感觉自己步入正轨，也相对稳定了下来。便想搞点事情，想做一个网站，包含自己一些平时想要的工具和一些自己想关注的咨询。然后发现自己的服务器竟然一点都不绿，所以就花了一些时间绿化了自己的服务器。 nginx 上 https…","html":"<h1>让服务器带点绿</h1>\n<blockquote>\n<p>这段时间终于感觉自己步入正轨，也相对稳定了下来。便想搞点事情，想做一个网站，包含自己一些平时想要的工具和一些自己想关注的咨询。然后发现自己的服务器竟然一点都不绿，所以就花了一些时间绿化了自己的服务器。</p>\n</blockquote>\n<h2>nginx 上 https</h2>\n<h3>申请证书</h3>\n<p>我自己用的是腾讯云服务器，因此证书就去腾讯云官方网站去申请，当然不是腾讯云的话还有几个比较权威的颁发证书的网站，例如 <a href=\"https://www.startcomca.com\">StartSSL</a>,当然如果你的服务器是 Linux 的话，你也可以用默认安装的 OpenSSL</p>\n<p>但是 OpenSSL 的方法我没有试过，具体可以参考</p>\n<p><a href=\"https://www.cnblogs.com/chjbbs/p/5748369.html\">https://www.cnblogs.com/chjbbs/p/5748369.html</a></p>\n<p>腾讯云的申请证书还是比较简单，打开下述链接</p>\n<p><a href=\"https://console.cloud.tencent.com/ssl\">https://console.cloud.tencent.com/ssl</a></p>\n<p>点击申请证书，然后根据其提示一步步填写，审核成功后下载证书，下载证书后里面的文件如下</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 584px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/13038162da3d05a7d1b4a57d4a26f13e/3064a/pg1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 19.006849315068493%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAAA7EAAAOxAGVKw4bAAAAmUlEQVQY012Q2w6DIBBE+f+f5AUv3NRYgaLIdKGxgU5CwsPZswNsGkd4H1CSc67nuZe8Q8CyLNi2jTiP+07QWuM8z457wuZ5Jij/ZP/CIjHGVKlzDiklSCkRY+y4Z5ZxzuFoqE0r9t5BKQVrLY7jK5yoRGwati3ZIASEGKCkqi2u6+o2B1pWZOu6kvDATUJrDfb91XHlC8oLPtsCOCsM/oWIAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"pg1\"\n        title=\"pg1\"\n        src=\"/static/13038162da3d05a7d1b4a57d4a26f13e/3064a/pg1.png\"\n        srcset=\"/static/13038162da3d05a7d1b4a57d4a26f13e/cf440/pg1.png 148w,\n/static/13038162da3d05a7d1b4a57d4a26f13e/d2d38/pg1.png 295w,\n/static/13038162da3d05a7d1b4a57d4a26f13e/3064a/pg1.png 584w\"\n        sizes=\"(max-width: 584px) 100vw, 584px\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>打开 Nginx，里面包含着一个证书文件和一个 .key 文件。</p>\n<h3>配置 nginx</h3>\n<p>打开服务器中的 nginx/conf 文件夹，在其中创建一个文件夹为 ssl，再创建一个文件夹为域名，这个完全看自己的习惯，在后面的配置项中只要路径对就可以。我的证书和 .key 文件的位置就在 nginx/conf/ssl/www.haoqinzz.cn/ 下</p>\n<p>然后找到 nginx.conf 文件，将其中如下代码解开封印并修改为如下代码</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\"># HTTPS server\n\n    server {\n       listen       443;\n       server_name  localhost;\n\n       ssl                  on;\n       ssl_certificate      ssl/www.haoqinzz.cn/1_www.haoqinzz.cn_bundle.crt;\n       ssl_certificate_key  ssl/www.haoqinzz.cn/2_www.haoqinzz.cn.key;\n\n       ssl_session_timeout  5m;\n\n       ssl_protocols  SSLv2 SSLv3 TLSv1;\n       ssl_prefer_server_ciphers   on;\n\n       ssl_dhparam ssl/certs/dhparam.pem;\n       ssl_ciphers &quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4&quot;;\n       keepalive_timeout 70;\n       ssl_session_cache shared:SSL:10m;\n\n       add_header Strict-Transport-Security max-age=63072000;\n       add_header X-Frame-Options DENY;\n       add_header X-Content-Type-Options nosniff;\n\n\n       location / {\n           root   html;\n           index  index.html index.htm;\n       }\n    }</code></pre></div>\n<p>然后再重启一下 nginx 服务即可，然后输入 <a href=\"https://haoqinzz.cn\">https://haoqinzz.cn</a> 就可以看到 nginx 的欢迎页，但此时你输入 <a href=\"http://haoqinzz.cn\">http://haoqinzz.cn</a> 还是可以访问的，所以如果想要全站都上 https ，还需要修改 http 的服务，将 http 重定向到 https 中</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\">server {\n    listen       80;\n    server_name  haoqinzz.cn www.haoqinzz.cn;\n    return 301 https://haoqinzz.cn$request_uri;\n}</code></pre></div>\n<p>这样你输入 <a href=\"http://haoqinzz.cn\">http://haoqinzz.cn</a> 会跳到 <a href=\"https://haoqinzz.cn\">https://haoqinzz.cn</a> 中，但是现在还存在一个很大的问题，就是我以前的项目也无法访问到了。。</p>\n<h2>让服务器中的项目重新运行</h2>\n<h3>基本项目</h3>\n<p>服务器上 https 后，首页改变了，所有项目都没了，我就去看了一下 nginx 的配置文件</p>\n<div class=\"gatsby-highlight\" data-language=\"conf\"><pre class=\"language-conf\"><code class=\"language-conf\"># HTTPS server\n\n    server {\n       listen       443;\n       server_name  localhost;\n\n       ssl                  on;\n       ssl_certificate      ssl/www.haoqinzz.cn/1_www.haoqinzz.cn_bundle.crt;\n       ssl_certificate_key  ssl/www.haoqinzz.cn/2_www.haoqinzz.cn.key;\n\n       ssl_session_timeout  5m;\n\n       ssl_protocols  SSLv2 SSLv3 TLSv1;\n       ssl_prefer_server_ciphers   on;\n\n       ssl_dhparam ssl/certs/dhparam.pem;\n       ssl_ciphers &quot;EECDH+ECDSA+AESGCM EECDH+aRSA+AESGCM EECDH+ECDSA+SHA384 EECDH+ECDSA+SHA256 EECDH+aRSA+SHA384 EECDH+aRSA+SHA256 EECDH+aRSA+RC4 EECDH EDH+aRSA !aNULL !eNULL !LOW !3DES !MD5 !EXP !PSK !SRP !DSS !RC4&quot;;\n       keepalive_timeout 70;\n       ssl_session_cache shared:SSL:10m;\n\n       add_header Strict-Transport-Security max-age=63072000;\n       add_header X-Frame-Options DENY;\n       add_header X-Content-Type-Options nosniff;\n\n\n       location / {\n           root   html;\n           index  index.html index.htm;\n       }\n    }</code></pre></div>\n<p>发现 https 的 root 文件夹为 html，因此我将原本的文件迁过来就可以访问了。:fist:</p>\n<h3>nginx 反向代理项目</h3>\n<p>在服务器上我还有过一个用 nginx 实现反向代理的项目，升 https 后毫无疑问 api 全部都是 404 了</p>\n<p>找到 nginx 反向代理的配置文件，将 Listen 端口 80 改为 443 ，并将以前的 http 协议都改为 https，然后此时再打开就可以找到 url ，但是会报 502 错误，经过仔细排查后发现这是因为我当时用 http 起的服务，要改为 https 并配置证书文件</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">var</span> https <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'https'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">const</span> fs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fs'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">const</span> options <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  key<span class=\"token punctuation\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'key文件'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  cert<span class=\"token punctuation\">:</span> fs<span class=\"token punctuation\">.</span><span class=\"token function\">readFileSync</span><span class=\"token punctuation\">(</span><span class=\"token string\">'crt文件'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">var</span> server <span class=\"token operator\">=</span> https<span class=\"token punctuation\">.</span><span class=\"token function\">createServer</span><span class=\"token punctuation\">(</span>options<span class=\"token punctuation\">,</span> app<span class=\"token punctuation\">)</span></code></pre></div>\n<p>这样数据便又可以获取到了</p>","frontmatter":{"title":"让服务器带点绿","date":"July 17, 2018"}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/让服务器带点绿/","previous":{"fields":{"slug":"/记一次oneinstack配置服务器/"},"frontmatter":{"title":"记一次 oneinstack 配置服务器"}},"next":{"fields":{"slug":"/获取百度搜索提示结果/"},"frontmatter":{"title":"获取百度搜索提示结果"}}}}}